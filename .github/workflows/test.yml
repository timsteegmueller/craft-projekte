{
  "meta": {
    "instanceId": "farbcode-craft-automation"
  },
  "name": "farbcode Craft CMS Auto-Update System",
  "nodes": [
    {
      "parameters": {},
      "id": "schedule-trigger",
      "name": "Weekly Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "",
      "credentials": {},
      "settings": {
        "schedule": {
          "rule": {
            "interval": [
              {
                "field": "cronExpression",
                "value": "0 3 * * 0"
              }
            ]
          }
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// farbcode Kunden-Projekte definieren\nconst projects = [\n  {\n    name: \"kunde-alpha-website\",\n    server: \"server01.farbcode.de\",\n    path: \"/var/www/kunde-alpha\",\n    github_repo: \"farbcode/kunde-alpha-craft\",\n    branch: \"main\",\n    domain: \"https://kunde-alpha.de\",\n    db_name: \"kunde_alpha_db\",\n    client: \"Alpha GmbH\"\n  },\n  {\n    name: \"kunde-beta-portal\",\n    server: \"server02.farbcode.de\", \n    path: \"/var/www/kunde-beta\",\n    github_repo: \"farbcode/kunde-beta-craft\",\n    branch: \"production\",\n    domain: \"https://beta-portal.com\",\n    db_name: \"kunde_beta_db\", \n    client: \"Beta Corporation\"\n  },\n  {\n    name: \"farbcode-website\",\n    server: \"main.farbcode.de\",\n    path: \"/var/www/farbcode\",\n    github_repo: \"farbcode/farbcode-website\",\n    branch: \"main\", \n    domain: \"https://farbcode.de\",\n    db_name: \"farbcode_main\",\n    client: \"farbcode Internal\"\n  }\n];\n\n// Projekte f√ºr Processing vorbereiten\nconst output = [];\nprojects.forEach((project, index) => {\n  output.push({\n    json: {\n      ...project,\n      project_id: index + 1,\n      timestamp: new Date().toISOString(),\n      update_type: \"scheduled\",\n      backup_path: `/backups/${project.name}`,\n      notification_channel: \"#farbcode-deployments\"\n    }\n  });\n});\n\nreturn output;"
      },
      "id": "project-config",
      "name": "farbcode Project Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {},
      "id": "loop-projects",
      "name": "Process Each Project",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "command": "# farbcode Server: Database Backup erstellen\nSSH_HOST=\"{{ $json.server }}\"\nPROJECT_PATH=\"{{ $json.path }}\"\nDB_NAME=\"{{ $json.db_name }}\"\nBACKUP_PATH=\"{{ $json.backup_path }}\"\n\necho \"üè¢ farbcode: Creating backup for {{ $json.client }}\"\necho \"üì° Server: $SSH_HOST\"\necho \"üíæ Database: $DB_NAME\"\n\n# SSH zu farbcode Server\nssh -o StrictHostKeyChecking=no farbcode@$SSH_HOST \\\n  \"cd $PROJECT_PATH && \\\n   mkdir -p $BACKUP_PATH && \\\n   mysqldump -u craft_user -p'{{ $secrets.DB_PASSWORD }}' $DB_NAME > $BACKUP_PATH/backup-$(date +%Y%m%d_%H%M%S).sql && \\\n   echo 'Backup created for {{ $json.name }}'\"\n\necho \"‚úÖ Backup completed for {{ $json.name }}\""
      },
      "id": "backup-database",
      "name": "farbcode DB Backup",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [900, 300],
      "credentials": {
        "ssh": {
          "id": "farbcode-ssh",
          "name": "farbcode SSH Keys"
        }
      }
    },
    {
      "parameters": {
        "command": "# farbcode Server: Craft CMS Updates ausf√ºhren\nSSH_HOST=\"{{ $json.server }}\"\nPROJECT_PATH=\"{{ $json.path }}\"\n\necho \"üöÄ farbcode: Updating Craft CMS for {{ $json.client }}\"\necho \"üìÇ Project: {{ $json.name }}\"\necho \"üñ•Ô∏è Server: $SSH_HOST\"\n\n# SSH zu farbcode Server und Updates ausf√ºhren\nssh -o StrictHostKeyChecking=no farbcode@$SSH_HOST \\\n  \"cd $PROJECT_PATH && \\\n   echo 'Starting Craft updates...' && \\\n   php craft update all --interactive=0 && \\\n   echo 'Updating Composer dependencies...' && \\\n   composer update --no-dev --optimize-autoloader && \\\n   echo 'Running Craft migrations...' && \\\n   php craft migrate/all --interactive=0 && \\\n   echo 'Clearing caches...' && \\\n   php craft clear-caches/all && \\\n   echo 'Updates completed for {{ $json.name }}'\"\n\necho \"‚úÖ Craft CMS updated for {{ $json.client }}\""
      },
      "id": "update-craft",
      "name": "farbcode Craft Update",
      "type": "n8n-nodes-base.executeCommand", 
      "typeVersion": 1,
      "position": [1120, 300],
      "credentials": {
        "ssh": {
          "id": "farbcode-ssh",
          "name": "farbcode SSH Keys"
        }
      }
    },
    {
      "parameters": {
        "command": "# farbcode: Git Operations f√ºr GitHub\nSSH_HOST=\"{{ $json.server }}\"\nPROJECT_PATH=\"{{ $json.path }}\"\nBRANCH_NAME=\"auto-update-$(date +%Y%m%d)\"\n\necho \"üì§ farbcode: Git operations for {{ $json.github_repo }}\"\necho \"üåø Creating branch: $BRANCH_NAME\"\n\n# SSH zu farbcode Server f√ºr Git-Operationen\nssh -o StrictHostKeyChecking=no farbcode@$SSH_HOST \\\n  \"cd $PROJECT_PATH && \\\n   echo 'Checking Git status...' && \\\n   git status && \\\n   echo 'Creating update branch...' && \\\n   git checkout -b $BRANCH_NAME && \\\n   echo 'Adding changed files...' && \\\n   git add composer.lock vendor/ config/project/ && \\\n   echo 'Committing changes...' && \\\n   git commit -m 'farbcode auto-update: Craft CMS dependencies $(date +%Y-%m-%d)' && \\\n   echo 'Pushing to GitHub...' && \\\n   git push origin $BRANCH_NAME && \\\n   echo 'Git operations completed'\"\n\necho \"‚úÖ Changes pushed to GitHub for {{ $json.client }}\"\necho \"üîó Branch: $BRANCH_NAME\""
      },
      "id": "git-operations",
      "name": "farbcode Git Push",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1, \n      "position": [1340, 300],
      "credentials": {
        "ssh": {
          "id": "farbcode-ssh",
          "name": "farbcode SSH Keys"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.github.com/repos/{{ $json.github_repo }}/pulls",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github+json"
            },
            {
              "name": "X-GitHub-Api-Version", 
              "value": "2022-11-28"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "title",
              "value": "ü§ñ farbcode Auto-Update: {{ $json.client }} Craft CMS Dependencies"
            },
            {
              "name": "head", 
              "value": "auto-update-{{ $now.format('YYYYMMDD') }}"
            },
            {
              "name": "base",
              "value": "{{ $json.branch }}"
            },
            {
              "name": "body",
              "value": "## üè¢ farbcode Automatische Updates\\n\\n**Kunde:** {{ $json.client }}\\n**Projekt:** {{ $json.name }}\\n**Server:** {{ $json.server }}\\n**Datum:** {{ $now.format('YYYY-MM-DD HH:mm') }}\\n\\n### ‚úÖ Durchgef√ºhrte Aktionen:\\n- üíæ Datenbank-Backup erstellt\\n- üöÄ Craft CMS Core aktualisiert\\n- üì¶ Composer Dependencies aktualisiert\\n- üîÑ Migrationen ausgef√ºhrt\\n- üóëÔ∏è Caches geleert\\n\\n### üîç √Ñnderungen:\\n- `composer.lock` - Dependency-Updates\\n- `config/project/` - Craft CMS Konfiguration\\n- `vendor/` - Updated packages\\n\\n### üìã Review-Checklist:\\n- [ ] Staging-Environment testen\\n- [ ] Backend-Funktionalit√§t pr√ºfen\\n- [ ] Frontend-Kompatibilit√§t checken\\n- [ ] Performance-Impact bewerten\\n- [ ] Kunden-Feedback einholen\\n\\n### üöÄ Deployment:\\n- [ ] Staging approved\\n- [ ] Client approval\\n- [ ] Production deployment\\n\\n---\\n*Automatisch erstellt von farbcode N8N Automation System*"
            }
          ]
        }
      },
      "id": "github-pr",
      "name": "farbcode GitHub PR", 
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1560, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "github-api",
          "name": "farbcode GitHub API"
        }
      }
    },
    {
      "parameters": {
        "url": "{{ $json.domain }}",
        "options": {
          "timeout": 10000,
          "followRedirect": true
        }
      },
      "id": "health-check",
      "name": "farbcode Health Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "health-status",
              "leftValue": "={{ $json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "status-check",
      "name": "Status Check",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "url": "{{ $secrets.FARBCODE_SLACK_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"channel\": \"#farbcode-deployments\", \n  \"username\": \"farbcode-automation\",\n  \"icon_emoji\": \": rocket:\",\n  \"text\": \"‚úÖ farbcode Craft CMS Update Success\",\n  \"attachments\": [\n    {\n      \"color\": \"good\",\n      \"title\": \"{{ $('farbcode Project Config').item.json.client }} - Update Completed\",\n      \"fields\": [\n        {\n          \"title\": \"Projekt\",\n          \"value\": \"{{ $('farbcode Project Config').item.json.name }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Server\", \n          \"value\": \"{{ $('farbcode Project Config').item.json.server }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Status\",\n          \"value\": \"HTTP {{ $json.statusCode }} ‚úÖ\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Zeit\",\n          \"value\": \"{{ $now.format('DD.MM.YYYY HH:mm') }}\",\n          \"short\": true\n        }\n      ],\n      \"actions\": [\n        {\n          \"type\": \"button\",\n          \"text\": \"GitHub PR ansehen\",\n          \"url\": \"https://github.com/{{ $('farbcode Project Config').item.json.github_repo }}/pulls\"\n        },\n        {\n          \"type\": \"button\", \n          \"text\": \"Website pr√ºfen\",\n          \"url\": \"{{ $('farbcode Project Config').item.json.domain }}\"\n        }\n      ]\n    }\n  ]\n}"
      },
      "id": "success-notification",
      "name": "farbcode Success Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "url": "{{ $secrets.FARBCODE_SLACK_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json", 
        "jsonBody": "{\n  \"channel\": \"#farbcode-alerts\",\n  \"username\": \"farbcode-automation\",\n  \"icon_emoji\": \":warning:\",\n  \"text\": \"üö® farbcode Craft CMS Update Error\",\n  \"attachments\": [\n    {\n      \"color\": \"danger\",\n      \"title\": \"{{ $('farbcode Project Config').item.json.client }} - Update Failed\",\n      \"fields\": [\n        {\n          \"title\": \"Projekt\",\n          \"value\": \"{{ $('farbcode Project Config').item.json.name }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Server\",\n          \"value\": \"{{ $('farbcode Project Config').item.json.server }}\", \n          \"short\": true\n        },\n        {\n          \"title\": \"Error\",\n          \"value\": \"HTTP {{ $json.statusCode || 'Connection Failed' }} ‚ùå\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Zeit\",\n          \"value\": \"{{ $now.format('DD.MM.YYYY HH:mm') }}\",\n          \"short\": true\n        }\n      ],\n      \"actions\": [\n        {\n          \"type\": \"button\",\n          \"text\": \"N8N Logs pr√ºfen\", \n          \"url\": \"https://n8n.farbcode.net/workflow/{{ $workflow.id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": \"Server SSH\",\n          \"url\": \"ssh://farbcode@{{ $('farbcode Project Config').item.json.server }}\"\n        }\n      ]\n    }\n  ]\n}"
      },
      "id": "error-notification", 
      "name": "farbcode Error Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 400]
    }
  ],
  "connections": {
    "Weekly Schedule": {
      "main": [
        [
          {
            "node": "farbcode Project Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "farbcode Project Config": {
      "main": [
        [
          {
            "node": "Process Each Project", 
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Project": {
      "main": [
        [
          {
            "node": "farbcode DB Backup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "farbcode DB Backup": {
      "main": [
        [
          {
            "node": "farbcode Craft Update",
            "type": "main", 
            "index": 0
          }
        ]
      ]
    },
    "farbcode Craft Update": {
      "main": [
        [
          {
            "node": "farbcode Git Push",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "farbcode Git Push": {
      "main": [
        [
          {
            "node": "farbcode GitHub PR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "farbcode GitHub PR": {
      "main": [
        [
          {
            "node": "farbcode Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "farbcode Health Check": {
      "main": [
        [
          {
            "node": "Status Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Check": {
      "main": [
        [
          {
            "node": "farbcode Success Notification",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "farbcode Error Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-07-08T12:00:00.000Z",
      "updatedAt": "2025-07-08T12:00:00.000Z", 
      "id": "farbcode-automation",
      "name": "farbcode"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-07-08T12:00:00.000Z",
  "versionId": "farbcode-v1.0"
}
