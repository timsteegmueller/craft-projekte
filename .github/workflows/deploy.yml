name: ğŸš€ Craft CMS Deployment with Backup

on:
  # Automatisch nach PR Merge
  push:
    branches: [ main, master ]
    paths:
      - 'craft-repo/**'
      - 'composer.json'
      - 'composer.lock'
      - 'config/**'
      - 'templates/**'
  
  # Manueller Trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_backup:
        description: 'Skip Database Backup?'
        required: false
        default: false
        type: boolean
      skip_health_check:
        description: 'Skip Health Check?'
        required: false
        default: false
        type: boolean
      rollback_commit:
        description: 'Rollback to specific commit (optional)'
        required: false
      force_deploy:
        description: 'Force deployment (ignore checks)'
        required: false
        default: false
        type: boolean

env:
  DEPLOYMENT_TIMEOUT: 300
  HEALTH_CHECK_RETRIES: 3

jobs:
  pre-deployment:
    name: ğŸ” Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      deploy_environment: ${{ steps.env.outputs.environment }}
      backup_required: ${{ steps.env.outputs.backup_required }}
      deployment_branch: ${{ steps.env.outputs.deployment_branch }}
      
    steps:
    - name: ğŸ”„ Repository auschecken
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Environment Setup
      id: env
      run: |
        # Environment bestimmen
        if [ "${{ github.event_name }}" = "push" ]; then
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            environment="production"
          else
            environment="staging"
          fi
          backup_required="true"
        else
          environment="${{ github.event.inputs.environment }}"
          backup_required="${{ !github.event.inputs.skip_backup }}"
        fi
        
        # Branch fÃ¼r Deployment
        if [ -n "${{ github.event.inputs.rollback_commit }}" ]; then
          deployment_branch="${{ github.event.inputs.rollback_commit }}"
        else
          deployment_branch="${{ github.ref_name }}"
        fi
        
        echo "environment=${environment}" >> $GITHUB_OUTPUT
        echo "backup_required=${backup_required}" >> $GITHUB_OUTPUT
        echo "deployment_branch=${deployment_branch}" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Deployment Environment: ${environment}"
        echo "ğŸ’¾ Backup Required: ${backup_required}"
        echo "ğŸŒ¿ Deployment Branch: ${deployment_branch}"

    - name: ğŸ” Pre-Deployment Validierung
      run: |
        echo "ğŸ” Validiere Deployment Voraussetzungen..."
        
        # Composer.json validieren
        if [ -f "composer.json" ]; then
          echo "âœ… composer.json gefunden"
        else
          echo "âŒ composer.json nicht gefunden!"
          exit 1
        fi
        
        # .env.example prÃ¼fen
        if [ -f ".env.example" ]; then
          echo "âœ… .env.example gefunden"
        fi
        
        # Craft CMS spezifische Dateien
        if [ -f "craft" ]; then
          echo "âœ… Craft Console gefunden"
        fi
        
        echo "âœ… Pre-Deployment Validierung erfolgreich"

  database-backup:
    name: ğŸ’¾ Database Backup
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.backup_required == 'true'
    outputs:
      backup_file: ${{ steps.backup.outputs.backup_file }}
      backup_path: ${{ steps.backup.outputs.backup_path }}
      backup_success: ${{ steps.backup.outputs.success }}
      
    steps:
    - name: ğŸ’¾ Server-seitiges Database Backup
      id: backup
      run: |
        environment="${{ needs.pre-deployment.outputs.deploy_environment }}"
        timestamp=$(date +%Y%m%d_%H%M%S)
        
        echo "ğŸ’¾ Erstelle Database Backup fÃ¼r ${environment}..."
        
        # SSH zum Server und Backup erstellen
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          # Backup-Verzeichnis erstellen
          sudo mkdir -p /var/backups/craft-cms/\$(date +%Y/%m/%d)
          
          # Backup-Dateiname
          BACKUP_FILE="craft_${environment}_backup_${timestamp}.sql"
          BACKUP_PATH="/var/backups/craft-cms/\$(date +%Y/%m/%d)/\${BACKUP_FILE}"
          
          echo "ğŸ—„ï¸ Erstelle MySQL Dump: \${BACKUP_PATH}"
          
          # MySQL Dump mit allen wichtigen Optionen
          mysqldump --single-transaction \\
                    --routines \\
                    --triggers \\
                    --events \\
                    --lock-tables=false \\
                    --add-drop-table \\
                    --create-options \\
                    --disable-keys \\
                    --extended-insert \\
                    --quick \\
                    --set-charset \\
                    -h \${{ secrets.DB_HOST || 'localhost' }} \\
                    -u \${{ secrets.DB_USER }} \\
                    -p\${{ secrets.DB_PASSWORD }} \\
                    \${{ secrets.DB_NAME }} > \${BACKUP_PATH}
          
          # Backup komprimieren
          gzip \${BACKUP_PATH}
          BACKUP_PATH="\${BACKUP_PATH}.gz"
          
          # Berechtigungen setzen
          sudo chown www-data:www-data \${BACKUP_PATH}
          sudo chmod 644 \${BACKUP_PATH}
          
          # Backup-Info ausgeben
          BACKUP_SIZE=\$(du -h \${BACKUP_PATH} | cut -f1)
          echo "âœ… Backup erstellt: \${BACKUP_PATH}"
          echo "ğŸ“Š Backup-GrÃ¶ÃŸe: \${BACKUP_SIZE}"
          
          # Backup-Metadaten erstellen
          cat > \${BACKUP_PATH%.gz}.info << INFOEOF
        Craft CMS Database Backup
        =========================
        Timestamp: \$(date)
        Environment: ${environment}
        Database: \${{ secrets.DB_NAME }}
        File: \$(basename \${BACKUP_PATH})
        Size: \${BACKUP_SIZE}
        Git Commit: \$(cd /var/www/\${{ secrets.CRAFT_PROJECT_PATH }} && git rev-parse HEAD)
        Server: \$(hostname)
        INFOEOF
          
          # Alte Backups aufrÃ¤umen (Ã¤lter als 7 Tage)
          find /var/backups/craft-cms -name "*.sql.gz" -mtime +7 -delete
          find /var/backups/craft-cms -name "*.info" -mtime +7 -delete
          echo "ğŸ§¹ Alte Backups (>7 Tage) gelÃ¶scht"
          
          # Aktuelle Backups anzeigen
          echo "ğŸ“‚ Aktuelle Backups in \$(date +%Y/%m/%d):"
          ls -la /var/backups/craft-cms/\$(date +%Y/%m/%d)/
          
          # FÃ¼r GitHub Actions Output
          echo "\${BACKUP_FILE}.gz"
          echo "\${BACKUP_PATH}"
        EOF
        
        # Backup-Info fÃ¼r GitHub Actions
        backup_file="craft_${environment}_backup_${timestamp}.sql.gz"
        backup_path="/var/backups/craft-cms/$(date +%Y/%m/%d)/${backup_file}"
        
        echo "backup_file=${backup_file}" >> $GITHUB_OUTPUT
        echo "backup_path=${backup_path}" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT
        echo "âœ… Server-seitiges Database Backup erfolgreich erstellt!"

    - name: ğŸ“Š Backup Verification
      run: |
        echo "ğŸ” Verifiziere Backup auf Server..."
        
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          BACKUP_PATH="${{ steps.backup.outputs.backup_path }}"
          
          if [ -f "\${BACKUP_PATH}" ]; then
            echo "âœ… Backup-Datei existiert: \${BACKUP_PATH}"
            echo "ğŸ“Š GrÃ¶ÃŸe: \$(du -h \${BACKUP_PATH} | cut -f1)"
            
            # Backup-IntegritÃ¤t prÃ¼fen
            if zcat \${BACKUP_PATH} | head -5 | grep -q "MySQL dump"; then
              echo "âœ… Backup-IntegritÃ¤t OK"
            else
              echo "âŒ Backup-IntegritÃ¤t FEHLER"
              exit 1
            fi
          else
            echo "âŒ Backup-Datei nicht gefunden!"
            exit 1
          fi
        EOF

  deployment:
    name: ğŸš€ Craft CMS Deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, database-backup]
    if: always() && (needs.database-backup.result == 'success' || needs.database-backup.result == 'skipped')
    outputs:
      deployment_success: ${{ steps.deploy.outputs.success }}
      deployment_url: ${{ steps.deploy.outputs.url }}
      git_commit: ${{ steps.deploy.outputs.git_commit }}
      
    steps:
    - name: ğŸš€ Craft CMS Deployment
      id: deploy
      timeout-minutes: 10
      run: |
        environment="${{ needs.pre-deployment.outputs.deploy_environment }}"
        branch="${{ needs.pre-deployment.outputs.deployment_branch }}"
        
        echo "ğŸš€ Deploying Craft CMS to ${environment} (Branch: ${branch})..."
        
        # SSH Deployment mit erweiterten Optionen
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          # Deployment-Start-Zeit
          START_TIME=\$(date +%s)
          echo "â° Deployment gestartet: \$(date)"
          
          # Craft CMS Verzeichnis
          PROJECT_PATH="/var/www/\${{ secrets.CRAFT_PROJECT_PATH }}"
          cd \${PROJECT_PATH}
          
          # Git-Info vor Update
          echo "ğŸ“‹ Aktueller Git Status:"
          git log -1 --format="Commit: %H%nAuthor: %an%nDate: %ad%nMessage: %s" --date=format:'%Y-%m-%d %H:%M:%S'
          
          # Maintenance Mode aktivieren (falls verfÃ¼gbar)
          if [ -f "craft" ]; then
            echo "ğŸ”§ Aktiviere Maintenance Mode..."
            php craft system/on-maintenance || echo "âš ï¸ Maintenance Mode nicht verfÃ¼gbar"
          fi
          
          # Git Pull/Checkout
          echo "ğŸ“¥ Updating Git repository..."
          git fetch origin
          
          if [ "${branch}" != "\$(git rev-parse --abbrev-ref HEAD)" ]; then
            git checkout ${branch}
          fi
          
          git reset --hard origin/${branch}
          
          # Git-Info nach Update
          NEW_COMMIT=\$(git rev-parse HEAD)
          echo "ğŸ“‹ Neuer Git Status:"
          git log -1 --format="Commit: %H%nAuthor: %an%nDate: %ad%nMessage: %s" --date=format:'%Y-%m-%d %H:%M:%S'
          
          # Composer Dependencies
          echo "ğŸ“¦ Installing/Updating Composer dependencies..."
          composer install --no-interaction \\
                          --prefer-dist \\
                          --optimize-autoloader \\
                          --no-dev \\
                          --no-progress \\
                          --no-suggest
          
          # File Permissions
          echo "ğŸ”§ Setting file permissions..."
          sudo chown -R www-data:www-data storage/
          sudo chown -R www-data:www-data config/
          sudo chown -R www-data:www-data web/uploads/
          sudo chmod -R 755 storage/
          sudo chmod -R 644 storage/logs/
          sudo chmod -R 755 web/uploads/
          
          # Craft CMS Commands
          if [ -f "craft" ]; then
            echo "âš¡ Running Craft CMS maintenance commands..."
            
            # Cache lÃ¶schen
            php craft clear-caches/all --no-interaction
            
            # Database Migrations
            php craft migrate/all --no-interaction --interactive=false
            
            # Project Config anwenden
            php craft project-config/apply --no-interaction --force
            
            # Search Index rebuild (falls nÃ¶tig)
            php craft search-indexes/rebuild --no-interaction || echo "âš ï¸ Search index rebuild skipped"
            
            # Asset Transforms lÃ¶schen (optional)
            php craft asset-transforms/delete-stale-transforms --no-interaction || echo "âš ï¸ Asset transforms cleanup skipped"
          fi
          
          # Frontend Build (falls vorhanden)
          if [ -f "package.json" ]; then
            echo "ğŸ¨ Building frontend assets..."
            if command -v npm >/dev/null 2>&1; then
              npm ci --production --silent
              npm run production --silent || npm run build --silent || echo "âš ï¸ Frontend build failed"
            fi
          fi
          
          # Maintenance Mode deaktivieren
          if [ -f "craft" ]; then
            echo "ğŸ”“ Deaktiviere Maintenance Mode..."
            php craft system/off-maintenance || echo "âš ï¸ Maintenance Mode deaktivierung fehlgeschlagen"
          fi
          
          # Deployment-End-Zeit
          END_TIME=\$(date +%s)
          DURATION=\$((END_TIME - START_TIME))
          
          echo "âœ… Deployment completed successfully!"
          echo "â° Deployment-Dauer: \${DURATION} Sekunden"
          echo "ğŸ“ Git Commit: \${NEW_COMMIT}"
          
          # Deployment-Log erstellen
          cat > storage/logs/deployment-\$(date +%Y%m%d_%H%M%S).log << LOGEOF
        Craft CMS Deployment Log
        ========================
        Environment: ${environment}
        Branch: ${branch}
        Start Time: \$(date -d @\${START_TIME})
        End Time: \$(date -d @\${END_TIME})
        Duration: \${DURATION} seconds
        Git Commit: \${NEW_COMMIT}
        Deployed by: GitHub Actions
        LOGEOF
          
          # Output fÃ¼r GitHub Actions
          echo "\${NEW_COMMIT}"
        EOF
        
        # Deployment URLs setzen
        if [ "${environment}" = "production" ]; then
          url="https://${{ secrets.PRODUCTION_DOMAIN }}"
        else
          url="https://${{ secrets.STAGING_DOMAIN }}"
        fi
        
        # Git Commit von Server abrufen
        git_commit=$(ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd /var/www/${{ secrets.CRAFT_PROJECT_PATH }} && git rev-parse HEAD")
        
        echo "success=true" >> $GITHUB_OUTPUT
        echo "url=${url}" >> $GITHUB_OUTPUT
        echo "git_commit=${git_commit}" >> $GITHUB_OUTPUT
        echo "âœ… Deployment to ${environment} completed: ${url}"

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: [pre-deployment, deployment]
    if: needs.deployment.outputs.deployment_success == 'true' && !inputs.skip_health_check
    
    steps:
    - name: ğŸ¥ Website Health Check
      timeout-minutes: 5
      run: |
        url="${{ needs.deployment.outputs.deployment_url }}"
        max_retries=${{ env.HEALTH_CHECK_RETRIES }}
        retry_count=0
        
        echo "ğŸ” Health Check fÃ¼r ${url}..."
        echo "ğŸ”„ Max Retries: ${max_retries}"
        
        while [ $retry_count -lt $max_retries ]; do
          echo "ğŸ” Versuch $((retry_count + 1))/${max_retries}..."
          
          # HTTP Status Check
          status_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${url}" || echo "000")
          response_time=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${url}" || echo "0")
          
          echo "ğŸ“Š Status Code: ${status_code}"
          echo "â±ï¸ Response Time: ${response_time}s"
          
          if [ "${status_code}" = "200" ]; then
            echo "âœ… Health Check PASSED!"
            
            # Erweiterte Checks
            echo "ğŸ” Erweiterte Health Checks..."
            
            # Admin Panel erreichbar?
            admin_status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "${url}/admin" || echo "000")
            echo "ğŸ” Admin Panel Status: ${admin_status}"
            
            # Craft-spezifische Checks
            if curl -s --max-time 15 "${url}" | grep -qi "craft\|cms" > /dev/null 2>&1; then
              echo "âœ… Craft CMS Content gefunden"
            fi
            
            # Performance Check
            if (( $(echo "${response_time} < 5.0" | bc -l) )); then
              echo "âœ… Performance OK (${response_time}s < 5s)"
            else
              echo "âš ï¸ Performance Warning (${response_time}s >= 5s)"
            fi
            
            break
          else
            echo "âŒ Health Check failed: ${status_code}"
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Warte 30 Sekunden vor nÃ¤chstem Versuch..."
              sleep 30
            fi
          fi
        done
        
        if [ $retry_count -eq $max_retries ]; then
          echo "âŒ Health Check failed nach ${max_retries} Versuchen!"
          exit 1
        fi

  notification:
    name: ğŸ“± Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment, database-backup, deployment, health-check]
    if: always()
    
    steps:
    - name: ğŸ“Š Deployment Summary
      run: |
        environment="${{ needs.pre-deployment.outputs.deploy_environment }}"
        
        echo "## ğŸ“Š Deployment Summary"
        echo "**Environment:** ${environment}"
        echo "**Branch:** ${{ needs.pre-deployment.outputs.deployment_branch }}"
        echo "**Git Commit:** ${{ needs.deployment.outputs.git_commit }}"
        echo "**URL:** ${{ needs.deployment.outputs.deployment_url }}"
        
        # Status Summary
        echo "### Status Overview:"
        echo "- **Pre-Deployment:** ${{ needs.pre-deployment.result }}"
        echo "- **Database Backup:** ${{ needs.database-backup.result }}"
        echo "- **Deployment:** ${{ needs.deployment.result }}"
        echo "- **Health Check:** ${{ needs.health-check.result }}"

    - name: ğŸ“± Slack Notification
      if: secrets.SLACK_WEBHOOK_URL != ''
      run: |
        environment="${{ needs.pre-deployment.outputs.deploy_environment }}"
        
        # Overall Status bestimmen
        if [ "${{ needs.deployment.result }}" = "success" ] && [ "${{ needs.health-check.result }}" = "success" ]; then
          status="âœ… SUCCESS"
          color="good"
          emoji="ğŸ‰"
        elif [ "${{ needs.deployment.result }}" = "success" ] && [ "${{ needs.health-check.result }}" = "skipped" ]; then
          status="âœ… SUCCESS (Health Check Skipped)"
          color="good"
          emoji="âœ…"
        else
          status="âŒ FAILED"
          color="danger"
          emoji="ğŸš¨"
        fi
        
        # Backup Info
        if [ "${{ needs.database-backup.result }}" = "success" ]; then
          backup_info="âœ… ${{ needs.database-backup.outputs.backup_file }}"
        elif [ "${{ needs.database-backup.result }}" = "skipped" ]; then
          backup_info="â­ï¸ Skipped"
        else
          backup_info="âŒ Failed"
        fi
        
        # Git Info
        git_short="${{ needs.deployment.outputs.git_commit }}"
        git_short="${git_short:0:8}"
        
        # Slack Payload
        curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "'${emoji}' Craft CMS Deployment - '${environment}'",
            "attachments": [
              {
                "color": "'${color}'",
                "title": "ğŸš€ Craft CMS Deployment",
                "fields": [
                  {
                    "title": "Status",
                    "value": "'${status}'",
                    "short": true
                  },
                  {
                    "title": "Environment", 
                    "value": "'${environment}'",
                    "short": true
                  },
                  {
                    "title": "Git Commit",
                    "value": "'${git_short}'",
                    "short": true
                  },
                  {
                    "title": "Database Backup",
                    "value": "'${backup_info}'",
                    "short": true
                  },
                  {
                    "title": "Website",
                    "value": "<${{ needs.deployment.outputs.deployment_url }}|Open Website>",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions â€¢ Craft CMS",
                "ts": '$(date +%s)'
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    name: ğŸ”„ Emergency Rollback
    runs-on: ubuntu-latest
    needs: [pre-deployment, database-backup, deployment, health-check]
    if: failure() && needs.database-backup.outputs.backup_success == 'true'
    
    steps:
    - name: ğŸš¨ Emergency Rollback Procedure
      timeout-minutes: 5
      run: |
        echo "ğŸš¨ EMERGENCY ROLLBACK INITIATED!"
        echo "ğŸ’¾ Using backup: ${{ needs.database-backup.outputs.backup_file }}"
        
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          echo "ğŸ”„ Starting emergency rollback..."
          
          cd /var/www/${{ secrets.CRAFT_PROJECT_PATH }}
          
          # Maintenance Mode aktivieren
          if [ -f "craft" ]; then
            php craft system/on-maintenance || echo "âš ï¸ Maintenance mode failed"
          fi
          
          # Git Rollback zum vorherigen funktionierenden Commit
          echo "ğŸ“‚ Git rollback..."
          git reset --hard HEAD~1
          
          # Database Rollback
          echo "ğŸ—„ï¸ Database rollback..."
          backup_path="${{ needs.database-backup.outputs.backup_path }}"
          
          if [ -f "\${backup_path}" ]; then
            zcat \${backup_path} | mysql -h ${{ secrets.DB_HOST || 'localhost' }} \\
                                         -u ${{ secrets.DB_USER }} \\
                                         -p${{ secrets.DB_PASSWORD }} \\
                                         ${{ secrets.DB_NAME }}
            echo "âœ… Database restored from backup"
          else
            echo "âŒ Backup file not found: \${backup_path}"
          fi
          
          # Composer Install (sicherstellen)
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
          
          # Craft Caches lÃ¶schen
          if [ -f "craft" ]; then
            php craft clear-caches/all --no-interaction
            php craft system/off-maintenance || echo "âš ï¸ Maintenance mode off failed"
          fi
          
          echo "ğŸ”„ Emergency rollback completed!"
        EOF
        
        echo "âœ… Emergency rollback procedure completed!"

    - name: ğŸš¨ Rollback Notification
      if: secrets.SLACK_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "ğŸš¨ EMERGENCY ROLLBACK EXECUTED",
            "attachments": [
              {
                "color": "warning",
                "title": "ğŸ”„ Craft CMS Emergency Rollback",
                "text": "Deployment failed - automatic rollback executed using database backup: ${{ needs.database-backup.outputs.backup_file }}",
                "footer": "GitHub Actions Emergency Response",
                "ts": '$(date +%s)'
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
