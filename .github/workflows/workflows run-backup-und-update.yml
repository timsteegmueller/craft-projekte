name: Craft CMS – Backup & Update

on:
  repository_dispatch:
    types: [run-craft-backup-update]

jobs:
  backup-and-update:
    runs-on: ubuntu-latest

    env:
      COMPOSER_DIR: mein-test-projekt
      MYSQL_DATABASE: craft
      MYSQL_USER: craft
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_PORT: 3306

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, gd, zip

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '5.7'
          mysql database: ${{ env.MYSQL_DATABASE }}
          mysql user: ${{ env.MYSQL_USER }}
          mysql password: ${{ env.MYSQL_PASSWORD }}
          mysql root password: ${{ env.MYSQL_ROOT_PASSWORD }}

      - name: Composer Install
        run: |
          echo "Arbeite in Verzeichnis: $COMPOSER_DIR"
          if [ ! -f "$COMPOSER_DIR/composer.json" ]; then
            echo "::error ::Keine composer.json in $COMPOSER_DIR gefunden!"
            exit 1
          fi
          cd "$COMPOSER_DIR"
          composer install --no-interaction --prefer-dist

      - name: Craft CLI prüfen
        run: |
          echo "Inhalt von vendor/bin:"
          ls -la "$COMPOSER_DIR/vendor/bin" || echo "::warning ::vendor/bin existiert nicht"
          if [ ! -f "$COMPOSER_DIR/vendor/bin/craft" ]; then
            echo "::error ::Craft CLI nicht gefunden! Stelle sicher, dass craftcms/cms installiert ist."
            exit 1
          fi

      - name: Backup + Update ausführen
        run: |
          cd "$COMPOSER_DIR"
          php vendor/bin/craft backup/db || echo "::warning ::Backup fehlgeschlagen"
          php vendor/bin/craft update all || echo "::warning ::Update fehlgeschlagen"
