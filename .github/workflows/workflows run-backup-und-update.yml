name: Craft CMS â€“ Backup & Update

on:
  repository_dispatch:
    types: [run-craft-backup-update]

jobs:
  backup-and-update:
    runs-on: ubuntu-latest

    env:
      COMPOSER_DIR: ./mein-test-projekt
      MYSQL_DATABASE: craft
      MYSQL_USER: craft
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_PORT: 3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, pdo_mysql, gd, zip

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '5.7'
          mysql database: ${{ env.MYSQL_DATABASE }}
          mysql user: ${{ env.MYSQL_USER }}
          mysql password: ${{ env.MYSQL_PASSWORD }}
          mysql root password: ${{ env.MYSQL_ROOT_PASSWORD }}

      - name: Install dependencies
        run: |
          cd "$COMPOSER_DIR"
          if [ ! -f "composer.json" ]; then
            echo "::error ::composer.json nicht gefunden in $COMPOSER_DIR"
            exit 1
          fi
          composer install --no-interaction --prefer-dist

      - name: Run Craft Backup & Update
        run: |
          cd "$COMPOSER_DIR"
          if [ ! -f "vendor/bin/craft" ]; then
            echo "::error ::Craft CLI nicht gefunden in $COMPOSER_DIR/vendor/bin"
            ls -la vendor/bin || true
            exit 1
          fi
          php vendor/bin/craft backup/db
          php vendor/bin/craft update all
