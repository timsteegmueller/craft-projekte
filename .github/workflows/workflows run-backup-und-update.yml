name: Craft CMS Auto-Backup & Update

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-craft-backup-update:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    env:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: craft
      MYSQL_USER: craft
      MYSQL_PASSWORD: secret

    steps:
      - name: 📥 Repo auschecken
        uses: actions/checkout@v4

      - name: 🐘 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_mysql, intl, curl, dom, zip, json
          tools: composer

      - name: 🔍 Finde `composer.json` im Projekt
        id: composer-locate
        run: |
          FOUND_PATH=$(find . -name "composer.json" | head -n 1 | xargs dirname)
          echo "COMPOSER_DIR=$FOUND_PATH" >> $GITHUB_ENV

      - name: 📦 Composer installieren
        run: |
          cd "$COMPOSER_DIR"
          composer install --no-interaction --no-progress --optimize-autoloader

      - name: 🐬 Starte temporäre MySQL Datenbank
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '5.7'
          mysql database: ${{ env.MYSQL_DATABASE }}
          mysql user: ${{ env.MYSQL_USER }}
          mysql password: ${{ env.MYSQL_PASSWORD }}
          mysql root password: ${{ env.MYSQL_ROOT_PASSWORD }}

      - name: 🧪 Starte Craft Backup
        run: |
          cd "$COMPOSER_DIR"
          if [ -f "craft" ]; then
            php craft backup/db
          else
            echo "❌ Keine Craft CLI gefunden in $COMPOSER_DIR"
            exit 1
          fi

      - name: 🚀 Führe PHP Update aus (Composer)
        run: |
          cd "$COMPOSER_DIR"
          composer update --no-interaction --no-progress

      - name: 🔁 n8n Webhook aufrufen
        run: |
          curl -X POST https://n8n.deine-webhook-url.de/webhook/test-craft-update \
            -H "Content-Type: application/json" \
            -d '{"repo": "${{ github.repository }}", "status": "done", "trigger": "github-action"}'
