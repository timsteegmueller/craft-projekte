name: ğŸ”„ Craft CMS Auto-Update + DB Backup

on:
  repository_dispatch:
    types: [craft-update]

jobs:
  update-craft:
    runs-on: ubuntu-latest
    env:
      WORK_DIR: ${{ github.event.client_payload.project_path || 'craft' }}

    steps:
      - name: ğŸ“¥ Repo auschecken
        uses: actions/checkout@v4

      - name: ğŸ˜ PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
          extensions: mbstring, intl, pdo_mysql, gd, zip

      - name: ğŸ¬ MySQL starten
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '5.7'
          mysql database: craftdb
          mysql user: root
          mysql password: secret
          mysql root password: secret

      - name: ğŸ”„ Composer Update ausfÃ¼hren
        id: update
        run: |
          echo "ğŸ§­ Arbeitsverzeichnis: $WORK_DIR"
          cd "$WORK_DIR"

          if [ ! -f "composer.json" ]; then
            echo "::error ::Keine composer.json in $WORK_DIR gefunden"
            exit 1
          fi

          composer install --no-dev --no-interaction
          composer update --dry-run > dryrun.txt || true

          if grep -q 'craftcms/cms' dryrun.txt; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            composer update --no-dev --no-interaction
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—„ï¸ MySQL Dump
        run: |
          mkdir -p backup
          mysqldump -h 127.0.0.1 -uroot -psecret craftdb > backup/db-$(date +%Y%m%d%H%M%S).sql

      - name: ğŸ“‹ Ã„nderungen committen
        if: steps.update.outputs.update_needed == 'true'
        run: |
          git config user.name "CraftBot"
          git config user.email "craft@farbcode.net"
          git add -A
          git commit -m "ğŸ”„ Update Craft CMS in $WORK_DIR" || echo "âš ï¸ Keine Ã„nderungen"

      - name: ğŸ” Pull Request erstellen
        if: steps.update.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”„ Update Craft CMS im Projekt $WORK_DIR"
          title: "ğŸ”„ Auto-Update ($WORK_DIR)"
          branch: update-${{ github.run_id }}
          delete-branch: true

      - name: ğŸ’¾ Backup bereitstellen
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: backup/
