name: 🔄 Modular Craft CMS Update

on:
  repository_dispatch:
    types: [craft-update]

jobs:
  update-craft:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: 📥 Repo auschecken
        uses: actions/checkout@v4

      - name: 🐘 PHP + Composer Setup
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ github.event.client_payload.php_version || '8.1' }}
          tools: composer:v2
          extensions: mbstring, intl, pdo_mysql, gd, zip

      - name: 🔄 In Projektverzeichnis wechseln
        run: |
          export WORK_DIR="${{ github.event.client_payload.project_path }}"
          echo "Arbeite im Verzeichnis: $WORK_DIR"
          cd "$WORK_DIR"
          
          composer install --no-dev --no-interaction || true
          composer update --dry-run >dryrun.txt || true

          if grep -q 'craftcms/cms' dryrun.txt; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            composer update --no-dev --no-interaction || true
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: 🗄️ Datenbank-Dump
        run: |
          mkdir -p backup
          mysqldump -h 127.0.0.1 \
            -u"${{ github.event.client_payload.db_user }}" \
            -p"${{ github.event.client_payload.db_pass }}" \
            "${{ github.event.client_payload.db_name }}" > backup/db-$(date +%Y%m%d%H%M%S).sql

      - name: 📝 Git commit & PR
        if: steps.update-craft.outputs.update_needed == 'true'
        run: |
          git config user.name "Craft Bot"
          git config user.email "craft@bot.farbcode"
          git add -A
          git commit -m "🔄 Update für Craft CMS bei Kunde: ${{ github.event.client_payload.project_path }}" || echo "⚠️ Nichts zu committen"

      - name: 🔁 Pull Request erstellen
        if: steps.update-craft.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🔄 Craft CMS Update für ${{ github.event.client_payload.project_path }}"
          title: "🔄 CMS Update (${{ github.event.client_payload.project_path }})"
          branch: update-${{ github.run_id }}
          delete-branch: true

      - name: 💾 Backup bereitstellen
        uses: actions/upload-artifact@v3
        with:
          name: db-backup-${{ github.event.client_payload.project_path }}
          path: backup/
