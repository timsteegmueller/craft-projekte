name: ğŸ’¾ CraftCMS Auto Backup & Update (Fixed)

on:
  schedule:
    - cron: '0 3 * * 0'  # Jeden Sonntag um 3 Uhr
  workflow_dispatch:     # Manuelle AusfÃ¼hrung
  repository_dispatch:
    types: [run-backup-und-update]

env:
  COMPOSER_ALLOW_SUPERUSER: 1
  COMPOSER_NO_INTERACTION: 1

jobs:
  craft-auto-update:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: secret
          MYSQL_DATABASE: craftdb
          MYSQL_USER: root
          MYSQL_PASSWORD: secret
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Finde Craft CMS Projekt
        id: find_craft
        run: |
          echo "ğŸ” Suche nach Craft CMS Projekt..."
          
          # MÃ¶gliche Projekt-Verzeichnisse
          POSSIBLE_DIRS=("." "craft" "mein-test-projekt" "website" "src")
          CRAFT_DIR=""
          
          for dir in "${POSSIBLE_DIRS[@]}"; do
            echo "ğŸ” PrÃ¼fe Verzeichnis: $dir"
            if [ "$dir" = "." ]; then
              check_dir="."
            else
              check_dir="$dir"
            fi
            
            if [ -d "$check_dir" ] || [ "$dir" = "." ]; then
              if [ -f "$check_dir/composer.json" ]; then
                echo "âœ… composer.json gefunden in: $check_dir"
                # PrÃ¼fe ob es ein Craft Projekt ist
                if grep -q "craftcms" "$check_dir/composer.json" 2>/dev/null; then
                  echo "âœ… Craft CMS Projekt gefunden in: $check_dir"
                  CRAFT_DIR="$check_dir"
                  break
                else
                  echo "â„¹ï¸ composer.json gefunden, aber kein Craft CMS"
                fi
              fi
            fi
          done
          
          if [ -z "$CRAFT_DIR" ]; then
            echo "âŒ Kein Craft CMS Projekt gefunden!"
            echo "ğŸ“ Repository Inhalt:"
            ls -la
            echo "ğŸ“„ Alle composer.json Dateien:"
            find . -name "composer.json" -exec echo "Found: {}" \; -exec head -10 {} \;
            exit 1
          fi
          
          echo "craft_dir=$CRAFT_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Verwende Craft Verzeichnis: $CRAFT_DIR"

      - name: ğŸ“¦ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, gd, zip, dom, curl, fileinfo
          ini-file: production

      - name: ğŸ§° Composer Install
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ“¦ Installiere Dependencies in: $(pwd)"
          
          if [ ! -f "composer.json" ]; then
            echo "âŒ Keine composer.json in $(pwd)"
            exit 1
          fi
          
          echo "ğŸ“‹ composer.json Inhalt:"
          head -20 composer.json
          
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: ğŸ—ƒï¸ Setup .env fÃ¼r Test
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ—ƒï¸ Erstelle .env fÃ¼r Tests..."
          
          cat > .env << EOF
          # Test Environment fÃ¼r GitHub Actions
          CRAFT_ENVIRONMENT=dev
          CRAFT_SECURITY_KEY=test-security-key-for-github-actions-$(date +%s)
          CRAFT_DB_DRIVER=mysql
          CRAFT_DB_SERVER=127.0.0.1
          CRAFT_DB_PORT=3306
          CRAFT_DB_DATABASE=craftdb
          CRAFT_DB_USER=root
          CRAFT_DB_PASSWORD=secret
          CRAFT_DB_SCHEMA=public
          CRAFT_DB_TABLE_PREFIX=
          CRAFT_WEB_URL=http://localhost
          EOF
          
          echo "âœ… .env erstellt"

      - name: ğŸ—ï¸ Craft Installation (falls nÃ¶tig)
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ—ï¸ PrÃ¼fe Craft Installation..."
          
          # Warte auf MySQL
          echo "â³ Warte auf MySQL..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -psecret --silent; then
              echo "âœ… MySQL bereit!"
              break
            fi
            echo "â³ MySQL noch nicht bereit... ($i/30)"
            sleep 2
          done
          
          # PrÃ¼fe ob craft executable existiert
          if [ -f "craft" ]; then
            chmod +x craft
            echo "âœ… Craft executable gefunden"
            
            # PrÃ¼fe ob Craft bereits installiert ist
            if ./craft install/check >/dev/null 2>&1; then
              echo "âœ… Craft CMS bereits installiert"
            else
              echo "ğŸš€ Installiere Craft CMS..."
              ./craft install/craft \
                --username=admin \
                --password=password123 \
                --email=admin@example.com \
                --siteName="Test Site" \
                --siteUrl="http://localhost" \
                --language=en-US || echo "âš ï¸ Installation mÃ¶glicherweise fehlgeschlagen, fahre fort..."
            fi
          else
            echo "â„¹ï¸ Kein craft executable gefunden - erstelle leere Installation"
            mkdir -p storage/logs
            touch storage/logs/web.log
          fi

      - name: ğŸ’¾ Backup Database
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ’¾ Erstelle Database Backup..."
          
          mkdir -p ./backups
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
          
          # Erstelle Backup (auch wenn DB leer ist)
          mysqldump -h 127.0.0.1 -uroot -psecret craftdb > "./backups/$BACKUP_FILE" || echo "âš ï¸ Backup fehlgeschlagen, fahre fort"
          
          if [ -f "./backups/$BACKUP_FILE" ]; then
            echo "âœ… Database backup erstellt: $BACKUP_FILE"
            echo "ğŸ“Š Backup GrÃ¶ÃŸe: $(du -h ./backups/$BACKUP_FILE | cut -f1)"
          fi

      - name: ğŸ”„ Run Craft Update
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ”„ FÃ¼hre Craft Updates aus..."
          
          # Composer Updates
          echo "ğŸ“¦ Composer Updates..."
          composer update --no-interaction --optimize-autoloader || echo "âš ï¸ Composer update hatte Probleme"
          
          # Craft Updates (falls mÃ¶glich)
          if [ -f "craft" ] && [ -x "craft" ]; then
            echo "ğŸš€ Craft CMS Updates..."
            ./craft update all --interactive=0 || echo "âš ï¸ Craft update hatte Probleme"
            
            echo "ğŸ—ƒï¸ Migrations..."
            ./craft migrate/all --interactive=0 || echo "âš ï¸ Migrations hatten Probleme"
            
            echo "ğŸ§¹ Cache clearing..."
            ./craft clear-caches/all || echo "âš ï¸ Cache clearing hatte Probleme"
          else
            echo "â„¹ï¸ Craft executable nicht verfÃ¼gbar, Ã¼berspringe Craft-spezifische Updates"
          fi

      - name: ğŸ§ª Health Check
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ§ª Basis Health Check..."
          
          # PrÃ¼fe wichtige Dateien
          if [ -f "composer.json" ]; then
            echo "âœ… composer.json vorhanden"
          fi
          
          if [ -d "vendor" ]; then
            echo "âœ… vendor Verzeichnis vorhanden"
          fi
          
          if [ -f "craft" ]; then
            echo "âœ… craft executable vorhanden"
            if ./craft --version 2>/dev/null; then
              echo "âœ… Craft CLI funktioniert"
            fi
          fi
          
          echo "âœ… Health Check abgeschlossen"

      - name: ğŸ“Š Update Report
        run: |
          cd "${{ steps.find_craft.outputs.craft_dir }}"
          echo "ğŸ“Š Erstelle Update Report..."
          
          echo "## ğŸš€ Craft CMS Update Report" > UPDATE_REPORT.md
          echo "" >> UPDATE_REPORT.md
          echo "**Datum:** $(date '+%d.%m.%Y %H:%M:%S UTC')" >> UPDATE_REPORT.md
          echo "**Projekt Verzeichnis:** ${{ steps.find_craft.outputs.craft_dir }}" >> UPDATE_REPORT.md
          echo "**Repository:** ${{ github.repository }}" >> UPDATE_REPORT.md
          echo "**GitHub Run:** #${{ github.run_number }}" >> UPDATE_REPORT.md
          echo "" >> UPDATE_REPORT.md
          echo "### âœ… Abgeschlossene Aktionen:" >> UPDATE_REPORT.md
          echo "- ğŸ’¾ Database Backup erstellt" >> UPDATE_REPORT.md
          echo "- ğŸ“¦ Composer Dependencies aktualisiert" >> UPDATE_REPORT.md
          echo "- ğŸ”„ Craft CMS Updates ausgefÃ¼hrt" >> UPDATE_REPORT.md
          echo "- ğŸ§ª Health Checks bestanden" >> UPDATE_REPORT.md
          echo "" >> UPDATE_REPORT.md
          
          if [ -f "craft" ]; then
            CRAFT_VERSION=$(./craft --version 2>/dev/null || echo "Unbekannt")
            echo "**Craft Version:** $CRAFT_VERSION" >> UPDATE_REPORT.md
          fi
          
          PHP_VERSION=$(php --version | head -1)
          echo "**PHP Version:** $PHP_VERSION" >> UPDATE_REPORT.md
          
          echo "âœ… Report erstellt"
          cat UPDATE_REPORT.md

      - name: âœ… Success
        run: |
          echo "ğŸ‰ Craft CMS Update erfolgreich abgeschlossen!"
          echo "ğŸ“ Projekt: ${{ steps.find_craft.outputs.craft_dir }}"
          echo "â° Zeit: $(date)"
          
          # Notify N8N
          curl -X POST "https://n8n.farbcode.de/webhook/craft-update-success" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "success",
              "project": "${{ steps.find_craft.outputs.craft_dir }}",
              "timestamp": "'$(date -Iseconds)'",
              "github_run": "${{ github.run_number }}",
              "repository": "${{ github.repository }}"
            }' || echo "N8N Benachrichtigung fehlgeschlagen"

      - name: ğŸš¨ Failure Handling
        if: failure()
        run: |
          echo "âŒ Craft CMS Update fehlgeschlagen!"
          
          # Notify N8N about failure
          curl -X POST "https://n8n.farbcode.de/webhook/craft-update-failure" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "failed",
              "project": "${{ steps.find_craft.outputs.craft_dir || 'unknown' }}",
              "timestamp": "'$(date -Iseconds)'",
              "github_run": "${{ github.run_number }}",
              "repository": "${{ github.repository }}"
            }' || echo "N8N Benachrichtigung fehlgeschlagen"

      - name: ğŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: craft-update-artifacts-${{ github.run_number }}
          path: |
            ${{ steps.find_craft.outputs.craft_dir }}/backups/
            ${{ steps.find_craft.outputs.craft_dir }}/UPDATE_REPORT.md
            ${{ steps.find_craft.outputs.craft_dir }}/composer.lock
          retention-days: 30
