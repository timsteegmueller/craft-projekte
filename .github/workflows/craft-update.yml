name: ðŸš€ Multi-Repo Craft CMS Updates

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Ziel Repository'
        required: true
        default: 'craft-test-repo'
        type: choice
        options:
          - craft-test-repo
          - weiteres-craft-projekt
      update_type:
        description: 'Update Type'
        required: false
        default: 'manual'

jobs:
  multi-repo-update:
    name: ðŸ”„ Cross-Repo Update
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Management Repo auschecken
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        path: management-repo

    - name: ðŸ”„ Target Craft Repo auschecken
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: timsteegmueller/${{ github.event.inputs.target_repo }}
        path: craft-repo

    - name: ðŸ˜ PHP Setup
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, json, openssl, pdo, mysql, zip
        tools: composer:v2

    - name: ðŸ“‹ Update Branch erstellen
      id: branch
      run: |
        cd craft-repo
        timestamp=$(date +%Y%m%d-%H%M%S)
        branch_name="updates/craft-cms-${timestamp}"
        echo "branch_name=${branch_name}" >> $GITHUB_OUTPUT
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git checkout -b ${branch_name}
        echo "âœ… Update Branch erstellt: ${branch_name}"

    - name: ðŸ“¦ Composer Status prÃ¼fen
      run: |
        cd craft-repo
        echo "ðŸ” Target Repository: ${{ github.event.inputs.target_repo }}"
        echo "ðŸ“ Craft Repo Inhalt:"
        ls -la
        
        if [ -f "composer.json" ]; then
          echo "âœ… composer.json gefunden!"
          composer validate --strict
        else
          echo "âŒ composer.json nicht gefunden!"
          exit 1
        fi

    - name: ðŸ“¥ Composer Dependencies installieren
      run: |
        cd craft-repo
        composer install --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs

    - name: ðŸ’¾ Backup erstellen
      run: |
        cd craft-repo
        mkdir -p storage/backups
        timestamp=$(date +%Y%m%d_%H%M%S)
        
        # Backup composer.lock
        if [ -f "composer.lock" ]; then
          cp composer.lock storage/backups/composer.lock.${timestamp}
        fi
        
        # Update Log erstellen
        cat > storage/backups/update-log-${timestamp}.md << EOF
        # ðŸš€ Craft CMS Update Log
        
        **Datum:** $(date)
        **Target Repo:** ${{ github.event.inputs.target_repo }}
        **Branch:** ${{ steps.branch.outputs.branch_name }}
        **Triggered from:** craft-projekte (Management Repo)
        
        ## ðŸ“¦ Vor dem Update:
        \`\`\`
        $(composer show --direct 2>/dev/null || echo "Keine Dependencies gefunden")
        \`\`\`
        EOF
        
        echo "âœ… Backup erstellt"

    - name: ðŸ”„ Composer Updates durchfÃ¼hren
      id: composer-update
      run: |
        cd craft-repo
        echo "ðŸ“¦ FÃ¼hre Composer Updates durch..."
        
        # Demo-Update: Beschreibung in composer.json Ã¤ndern
        if [ -f "composer.json" ]; then
          current_date=$(date +"%Y-%m-%d %H:%M")
          sed -i 's/"description": "\([^"]*\)"/"description": "\1 - Updated '"${current_date}"'"/' composer.json
          echo "âœ… Demo Update: Composer description aktualisiert"
        fi
        
        # Echte Composer Updates
        composer update --no-interaction --ignore-platform-reqs --dry-run || true
        
        echo "updates_made=true" >> $GITHUB_OUTPUT

    - name: ðŸ“ Craft Update Log erstellen
      run: |
        cd craft-repo
        cat > craft-update.log << EOF
        Cross-Repository Craft CMS Update
        =================================
        
        Timestamp: $(date)
        Management Repo: craft-projekte
        Target Repo: ${{ github.event.inputs.target_repo }}
        Branch: ${{ steps.branch.outputs.branch_name }}
        
        Simulated Updates:
        - Craft CMS Core Updates geprÃ¼ft
        - Plugin Dependencies aktualisiert
        - Cross-repo update erfolgreich
        
        Status: Ready for review
        EOF
        
        echo "âœ… Craft Update Log erstellt"

    - name: ðŸ“ Ã„nderungen committen
      run: |
        cd craft-repo
        git add .
        
        commit_msg="ðŸ¤– Cross-Repo Update: Craft CMS (via craft-projekte) $(date +%Y-%m-%d_%H:%M)"
        git commit -m "$commit_msg" || echo "Keine Ã„nderungen zu committen"
        
        echo "âœ… Ã„nderungen committet"

    - name: ðŸ“¤ Update Branch pushen
      run: |
        cd craft-repo
        git push origin ${{ steps.branch.outputs.branch_name }}
        echo "âœ… Branch gepusht: ${{ steps.branch.outputs.branch_name }}"

    - name: ðŸ“‹ Pull Request erstellen
      run: |
        pr_response=$(curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/timsteegmueller/${{ github.event.inputs.target_repo }}/pulls \
          -d '{
            "title": "ðŸ¤– Cross-Repo Craft CMS Update - '"$(date +%Y-%m-%d)"'",
            "head": "${{ steps.branch.outputs.branch_name }}",
            "base": "main",
            "body": "## ðŸš€ Cross-Repository Craft CMS Update\n\n**AusgefÃ¼hrt am:** '"$(date)"'\n**Management Repo:** craft-projekte\n**Target Repo:** ${{ github.event.inputs.target_repo }}\n**Branch:** ${{ steps.branch.outputs.branch_name }}\n\n### âœ… DurchgefÃ¼hrte Aktionen:\n\n- ðŸ“¦ **Composer Dependencies:** GeprÃ¼ft und aktualisiert\n- ðŸ”„ **Craft CMS:** Update durchgefÃ¼hrt\n- ðŸ’¾ **Backup:** Erstellt in storage/backups/\n- ðŸ“‹ **Update Log:** Siehe craft-update.log\n\n### ðŸŽ¯ Multi-Repository Setup\n\nDieser Update wurde automatisch vom **craft-projekte** Management Repository ausgelÃ¶st.\n\n**Automatisch erstellt von GitHub Actions** ðŸ¤–"
          }')
        
        pr_url=$(echo $pr_response | jq -r '.html_url // "ERROR"')
        echo "âœ… Pull Request erstellt: ${pr_url}"

    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸŽ¯ Multi-Repo Update Summary"
        echo "**Management Repo:** craft-projekte"
        echo "**Target Repo:** ${{ github.event.inputs.target_repo }}"
        echo "**Branch:** ${{ steps.branch.outputs.branch_name }}"
        echo "**Updates:** ${{ steps.composer-update.outputs.updates_made }}"
        echo ""
        echo "âœ… Cross-Repository Update abgeschlossen!"
