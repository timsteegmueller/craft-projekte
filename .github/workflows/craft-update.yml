name: 🔄 Modular Craft CMS Update

on:
  repository_dispatch:
    types: [craft-update]

env:
  DB_NAME: ${{ github.event.client_payload.db_name }}
  SSH_USER: ${{ github.event.client_payload.ssh_user }}
  SSH_HOST: ${{ github.event.client_payload.ssh_host }}
  SITE_HOST: ${{ github.event.client_payload.site_host }}

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, pdo_mysql, gd, zip
          tools: composer

      - name: 🗄️ Datenbank-Backup via SSH
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST \
            "mysqldump -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASS }} $DB_NAME > ~/backups/backup-$(date +%Y%m%d).sql"

      - name: 📦 Composer Update Check
        id: update
        run: |
          composer install --no-dev --no-interaction
          composer update --dry-run >check.txt || true
          if grep -q 'craftcms/cms' check.txt; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔄 Composer Update durchführen
        if: steps.update.outputs.update_needed == 'true'
        run: composer update --no-dev --no-interaction

      - name: 🌐 HTTP-Test
        if: steps.update.outputs.update_needed == 'true'
        run: |
          status=$(curl -s -o /dev/null -w '%{http_code}' https://$SITE_HOST/)
          if [ "$status" != "200" ]; then
            echo "::error ::HTTP-Test fehlgeschlagen ($status statt 200)"
            exit 1
          fi

      - name: 📋 Git Commit vorbereiten
        if: steps.update.outputs.update_needed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "🔄 Automatisches Craft CMS Update" || echo "⚠️ Nichts zu committen"


     
